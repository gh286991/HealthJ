name: ğŸš€ Deploy to Zeabur

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stg
          - prod
      backend_branch:
        description: 'å¾Œç«¯å°ˆæ¡ˆåˆ†æ”¯ (HealthRecord)'
        required: true
        default: 'develop'
        type: string
      frontend_branch:
        description: 'å‰ç«¯å°ˆæ¡ˆåˆ†æ”¯ (HealthRecord-FE)'
        required: true
        default: 'develop'
        type: string
      build_backend:
        description: 'æ˜¯å¦å»ºç½®å¾Œç«¯'
        required: false
        default: true
        type: boolean
      build_frontend:
        description: 'æ˜¯å¦å»ºç½®å‰ç«¯'
        required: false
        default: true
        type: boolean
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½²ï¼ˆè·³éæ¸¬è©¦ï¼‰'
        required: false
        default: false
        type: boolean

env:
  ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
  ZEABUR_PROJECT_ID: ${{ secrets.ZEABUR_PROJECT_ID }}
  NODE_ENV: ${{ github.event.inputs.environment }}

concurrency:
  group: deploy-${{ github.event.inputs.environment }}-${{ github.event.inputs.backend_branch }}-${{ github.event.inputs.frontend_branch }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  validate-inputs:
    name: ğŸ” é©—è­‰è¼¸å…¥åƒæ•¸
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      backend-branch: ${{ steps.validate.outputs.backend_branch }}
      frontend-branch: ${{ steps.validate.outputs.frontend_branch }}
      should-build-backend: ${{ steps.validate.outputs.should_build_backend }}
      should-build-frontend: ${{ steps.validate.outputs.should_build_frontend }}
      force-deploy: ${{ steps.validate.outputs.force_deploy }}
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼ä»¥åµæ¸¬åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: åµæ¸¬å¯ç”¨åˆ†æ”¯
        id: detect-branches
        run: |
          echo "ğŸ” åµæ¸¬å¯ç”¨åˆ†æ”¯..."
          
          # åµæ¸¬å¾Œç«¯å°ˆæ¡ˆåˆ†æ”¯
          echo "ğŸ—ï¸  å¾Œç«¯å°ˆæ¡ˆ (HealthRecord) å¯ç”¨åˆ†æ”¯ï¼š"
          cd HealthRecord
          git branch -r | grep -v HEAD | sed 's/origin\///' | sort -u
          BACKEND_BRANCHES=$(git branch -r | grep -v HEAD | sed 's/origin\///' | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "backend_branches=$BACKEND_BRANCHES" >> $GITHUB_OUTPUT
          cd ..
          
          echo ""
          echo "ğŸ¨ å‰ç«¯å°ˆæ¡ˆ (HealthRecord-FE) å¯ç”¨åˆ†æ”¯ï¼š"
          cd HealthRecord-FE
          git branch -r | grep -v HEAD | sed 's/origin\///' | sort -u
          FRONTEND_BRANCHES=$(git branch -r | grep -v HEAD | sed 's/origin\///' | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "frontend_branches=$FRONTEND_BRANCHES" >> $GITHUB_OUTPUT
          cd ..
          
          echo ""
          echo "ğŸ“‹ åˆ†æ”¯åµæ¸¬å®Œæˆ"

      - name: é©—è­‰ç’°å¢ƒå’Œåˆ†æ”¯çµ„åˆ
        id: validate
        run: |
          ENV="${{ github.event.inputs.environment }}"
          BACKEND_BRANCH="${{ github.event.inputs.backend_branch }}"
          FRONTEND_BRANCH="${{ github.event.inputs.frontend_branch }}"
          
          echo "ğŸ” é©—è­‰éƒ¨ç½²é…ç½®..."
          echo "ğŸ“ ç’°å¢ƒ: $ENV"
          echo "ğŸ—ï¸  å¾Œç«¯åˆ†æ”¯: $BACKEND_BRANCH"
          echo "ğŸ¨ å‰ç«¯åˆ†æ”¯: $FRONTEND_BRANCH"
          
          # é©—è­‰ç’°å¢ƒå’Œåˆ†æ”¯çš„åˆç†æ€§ï¼ˆå¯é¸çš„åš´æ ¼é©—è­‰ï¼‰
          case "$ENV" in
            "dev")
              echo "â„¹ï¸  é–‹ç™¼ç’°å¢ƒ - å…è¨±ä½¿ç”¨ä»»ä½•åˆ†æ”¯é€²è¡Œæ¸¬è©¦"
              ;;
            "stg")
              echo "â„¹ï¸  æ¸¬è©¦ç’°å¢ƒ - å»ºè­°ä½¿ç”¨ staging åˆ†æ”¯ï¼Œä½†å…è¨±å…¶ä»–åˆ†æ”¯"
              ;;
            "prod")
              # ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ç©©å®šåˆ†æ”¯
              if [[ "$BACKEND_BRANCH" != "main" && "$BACKEND_BRANCH" != "staging" ]]; then
                echo "âš ï¸  è­¦å‘Šï¼šç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ main æˆ– staging åˆ†æ”¯"
              fi
              if [[ "$FRONTEND_BRANCH" != "main" && "$FRONTEND_BRANCH" != "staging" ]]; then
                echo "âš ï¸  è­¦å‘Šï¼šç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ main æˆ– staging åˆ†æ”¯"
              fi
              ;;
          esac
          
          echo "âœ… ç’°å¢ƒå’Œåˆ†æ”¯çµ„åˆé©—è­‰é€šé"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "backend_branch=$BACKEND_BRANCH" >> $GITHUB_OUTPUT
          echo "frontend_branch=$FRONTEND_BRANCH" >> $GITHUB_OUTPUT
          echo "should_build_backend=${{ github.event.inputs.build_backend }}" >> $GITHUB_OUTPUT
          echo "should_build_frontend=${{ github.event.inputs.build_frontend }}" >> $GITHUB_OUTPUT
          echo "force_deploy=${{ github.event.inputs.force_deploy }}" >> $GITHUB_OUTPUT

  checkout-code:
    name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
    runs-on: ubuntu-latest
    needs: validate-inputs
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-inputs.outputs.backend-branch }}
          submodules: recursive
          fetch-depth: 0

      - name: é¡¯ç¤ºåˆ†æ”¯è³‡è¨Š
        run: |
          echo "ğŸ” ç•¶å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "ğŸ” å¾Œç«¯åˆ†æ”¯: ${{ needs.validate-inputs.outputs.backend-branch }}"
          echo "ğŸ” å‰ç«¯åˆ†æ”¯: ${{ needs.validate-inputs.outputs.frontend-branch }}"
          echo "ğŸ” æœ€æ–°æäº¤: $(git log -1 --oneline)"
          echo "ğŸ” æäº¤è€…: $(git log -1 --pretty=format:'%an <%ae>')"

  run-tests:
    name: ğŸ§ª åŸ·è¡Œæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [validate-inputs, checkout-code]
    if: ${{ !needs.validate-inputs.outputs.force-deploy }}
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼ï¼ˆå«å­æ¨¡çµ„ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: åˆ‡æ›å­æ¨¡çµ„åˆ†æ”¯ï¼ˆå¾Œç«¯/å‰ç«¯ï¼‰
        run: |
          echo "åˆ‡æ›å¾Œç«¯å­æ¨¡çµ„åˆ°åˆ†æ”¯: ${{ needs.validate-inputs.outputs.backend-branch }}"
          git -C HealthRecord fetch origin ${{ needs.validate-inputs.outputs.backend-branch }}
          git -C HealthRecord checkout ${{ needs.validate-inputs.outputs.backend-branch }} || git -C HealthRecord checkout -b ${{ needs.validate-inputs.outputs.backend-branch }} origin/${{ needs.validate-inputs.outputs.backend-branch }}
          git -C HealthRecord pull origin ${{ needs.validate-inputs.outputs.backend-branch }}

          echo "åˆ‡æ›å‰ç«¯å­æ¨¡çµ„åˆ°åˆ†æ”¯: ${{ needs.validate-inputs.outputs.frontend-branch }}"
          git -C HealthRecord-FE fetch origin ${{ needs.validate-inputs.outputs.frontend-branch }}
          git -C HealthRecord-FE checkout ${{ needs.validate-inputs.outputs.frontend-branch }} || git -C HealthRecord-FE checkout -b ${{ needs.validate-inputs.outputs.frontend-branch }} origin/${{ needs.validate-inputs.outputs.frontend-branch }}
          git -C HealthRecord-FE pull origin ${{ needs.validate-inputs.outputs.frontend-branch }}

      - name: è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: åŸ·è¡Œå¾Œç«¯æ¸¬è©¦
        working-directory: HealthRecord
        run: |
          echo "ğŸ§ª åŸ·è¡Œå¾Œç«¯æ¸¬è©¦..."
          docker build \
            --target builder \
            --tag healthrecord-backend-test:${{ needs.validate-inputs.outputs.backend-branch }} \
            .
          docker run --rm healthrecord-backend-test:${{ needs.validate-inputs.outputs.backend-branch }} yarn test

      - name: åŸ·è¡Œå‰ç«¯æ¸¬è©¦
        working-directory: HealthRecord-FE
        run: |
          echo "ğŸ§ª åŸ·è¡Œå‰ç«¯æ¸¬è©¦..."
          docker build \
            --target builder \
            --tag healthrecord-frontend-test:${{ needs.validate-inputs.outputs.frontend-branch }} \
            .
          docker run --rm healthrecord-frontend-test:${{ needs.validate-inputs.outputs.frontend-branch }} yarn test

      - name: åŸ·è¡Œ E2E æ¸¬è©¦
        working-directory: HealthRecord-FE
        run: |
          echo "ğŸ§ª åŸ·è¡Œ E2E æ¸¬è©¦..."
          docker run --rm healthrecord-frontend-test:${{ needs.validate-inputs.outputs.frontend-branch }} yarn cypress:run

  build-backend:
    name: ğŸ—ï¸ å»ºç½®å¾Œç«¯
    runs-on: ubuntu-latest
    needs: [validate-inputs, checkout-code]
    if: ${{ needs.validate-inputs.outputs.should-build-backend }}
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼ï¼ˆå«å­æ¨¡çµ„ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: åˆ‡æ›å¾Œç«¯å­æ¨¡çµ„åˆ†æ”¯
        run: |
          echo "åˆ‡æ›å¾Œç«¯å­æ¨¡çµ„åˆ°åˆ†æ”¯: ${{ needs.validate-inputs.outputs.backend-branch }}"
          git -C HealthRecord fetch origin ${{ needs.validate-inputs.outputs.backend-branch }}
          git -C HealthRecord checkout ${{ needs.validate-inputs.outputs.backend-branch }} || git -C HealthRecord checkout -b ${{ needs.validate-inputs.outputs.backend-branch }} origin/${{ needs.validate-inputs.outputs.backend-branch }}
          git -C HealthRecord pull origin ${{ needs.validate-inputs.outputs.backend-branch }}

      - name: è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: å»ºç½®å¾Œç«¯ Docker æ˜ åƒ
        working-directory: HealthRecord
        run: |
          echo "ğŸ—ï¸ å»ºç½®å¾Œç«¯ Docker æ˜ åƒ..."
          docker build \
            --tag healthrecord-backend:${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.backend-branch }} \
            --build-arg NODE_ENV=${{ needs.validate-inputs.outputs.environment }} \
            .

      - name: åŒ¯å‡ºå¾Œç«¯å»ºç½®æˆå“ï¼ˆå¾æ˜ åƒè¤‡è£½ distï¼‰
        working-directory: HealthRecord
        run: |
          echo "ğŸ“¦ åŒ¯å‡ºå¾Œç«¯ dist æˆå“..."
          mkdir -p dist
          CID=$(docker create healthrecord-backend:${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.backend-branch }})
          docker cp "$CID":/app/dist ./dist || (echo "âŒ æ‰¾ä¸åˆ° /app/distï¼Œè«‹ç¢ºèª Dockerfile æ˜¯å¦æœ‰è¼¸å‡º dist" && exit 1)
          docker rm "$CID"

      - name: ä¸Šå‚³å¾Œç«¯å»ºç½®æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.backend-branch }}
          path: HealthRecord/dist/
          retention-days: 1

  build-frontend:
    name: ğŸ—ï¸ å»ºç½®å‰ç«¯
    runs-on: ubuntu-latest
    needs: [validate-inputs, checkout-code]
    if: ${{ needs.validate-inputs.outputs.should-build-frontend }}
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼ï¼ˆå«å­æ¨¡çµ„ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: åˆ‡æ›å‰ç«¯å­æ¨¡çµ„åˆ†æ”¯
        run: |
          echo "åˆ‡æ›å‰ç«¯å­æ¨¡çµ„åˆ°åˆ†æ”¯: ${{ needs.validate-inputs.outputs.frontend-branch }}"
          git -C HealthRecord-FE fetch origin ${{ needs.validate-inputs.outputs.frontend-branch }}
          git -C HealthRecord-FE checkout ${{ needs.validate-inputs.outputs.frontend-branch }} || git -C HealthRecord-FE checkout -b ${{ needs.validate-inputs.outputs.frontend-branch }} origin/${{ needs.validate-inputs.outputs.frontend-branch }}
          git -C HealthRecord-FE pull origin ${{ needs.validate-inputs.outputs.frontend-branch }}

      - name: è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: å»ºç½®å‰ç«¯ Docker æ˜ åƒ
        working-directory: HealthRecord-FE
        run: |
          echo "ğŸ¨ å»ºç½®å‰ç«¯ Docker æ˜ åƒ..."
          docker build \
            --tag healthrecord-frontend:${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.frontend-branch }} \
            --build-arg NODE_ENV=${{ needs.validate-inputs.outputs.environment }} \
            .

      - name: åŒ¯å‡ºå‰ç«¯å»ºç½®æˆå“ï¼ˆå¾æ˜ åƒè¤‡è£½ .nextï¼‰
        working-directory: HealthRecord-FE
        run: |
          echo "ğŸ“¦ åŒ¯å‡ºå‰ç«¯ .next æˆå“..."
          mkdir -p .next
          CID=$(docker create healthrecord-frontend:${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.frontend-branch }})
          docker cp "$CID":/app/.next ./.next || (echo "âŒ æ‰¾ä¸åˆ° /app/.nextï¼Œè«‹ç¢ºèª Dockerfile æ˜¯å¦æœ‰è¼¸å‡º .next" && exit 1)
          docker rm "$CID"
          echo "ğŸ“‚ åˆ—å‡º HealthRecord-FE ç›®éŒ„å…§å®¹ï¼š"
          ls -la
          echo "ğŸ“‚ åˆ—å‡º .next ç›®éŒ„å…§å®¹ï¼š"
          ls -la .next || true
          echo "ğŸ“„ ç¯„ä¾‹åˆ—å‡º .next å‰ 50 å€‹æª”æ¡ˆï¼š"
          find .next -type f | head -50 || true

      - name: ä¸Šå‚³å‰ç«¯å»ºç½®æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.frontend-branch }}
          path: |
            HealthRecord-FE/.next/**
            HealthRecord-FE/public/**
            HealthRecord-FE/package.json
          if-no-files-found: error
          retention-days: 1

  deploy-to-zeabur:
    name: ğŸš€ éƒ¨ç½²åˆ° Zeabur
    runs-on: ubuntu-latest
    needs: [validate-inputs, checkout-code, run-tests, build-backend, build-frontend]
    if: always() && (needs.run-tests.result == 'success' || needs.validate-inputs.outputs.force-deploy == 'true')
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼ï¼ˆç”¨æ–¼éƒ¨ç½²é…ç½®ï¼‰
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-inputs.outputs.backend-branch }}
          submodules: recursive

      - name: ä¸‹è¼‰å¾Œç«¯å»ºç½®æˆå“
        if: needs.build-backend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: backend-build-${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.backend-branch }}
          path: ./backend-build

      - name: ä¸‹è¼‰å‰ç«¯å»ºç½®æˆå“
        if: needs.build-frontend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.validate-inputs.outputs.environment }}-${{ needs.validate-inputs.outputs.frontend-branch }}
          path: ./frontend-build

      - name: å®‰è£ Zeabur CLI
        run: |
          set -euo pipefail
          echo "ğŸ“¥ å®‰è£ Zeabur CLI..."
          # Try multiple installation methods
          if ! curl -fsSL https://zeabur.com/install.sh | sh; then
            echo "First method failed, trying alternative..."
            if ! curl -fsSL https://get.zeabur.sh | sh; then
              echo "Second method failed, trying npm..."
              npm install -g @zeabur/cli || true
            fi
          fi
          
          # Add multiple possible paths
          echo "$HOME/.local/bin" >> $GITHUB_PATH || true
          echo "$HOME/.zeabur/bin" >> $GITHUB_PATH || true
          echo "/usr/local/bin" >> $GITHUB_PATH || true
          echo "/usr/bin" >> $GITHUB_PATH || true
          
          # Debug path and check installation
          echo "PATH after update: $PATH"
          ls -la "$HOME/.local/bin" 2>/dev/null || echo "No ~/.local/bin"
          ls -la "$HOME/.zeabur/bin" 2>/dev/null || echo "No ~/.zeabur/bin"
          
          # Test zeabur command
          export PATH="$HOME/.local/bin:$HOME/.zeabur/bin:/usr/local/bin:$PATH"
          ls -la "$HOME/.zeabur/bin" || true
          which zeabur || true
          if command -v zeabur >/dev/null 2>&1; then
            zeabur --version || true
          else
            echo "âš ï¸  zeabur å°šæœªåœ¨ PATHï¼Œå°‡å˜—è©¦ä½¿ç”¨å®Œæ•´è·¯å¾‘åŸ·è¡Œ";
            if [ -x "$HOME/.local/bin/zeabur" ]; then "$HOME/.local/bin/zeabur" --version || true; fi
            if [ -x "$HOME/.zeabur/bin/zeabur" ]; then "$HOME/.zeabur/bin/zeabur" --version || true; fi
          fi

      - name: è¨­å®š Zeabur èªè­‰
        run: |
          set -euo pipefail
          if command -v zeabur >/dev/null 2>&1; then
            echo "$ZEABUR_TOKEN" | zeabur login
          elif [ -x "$HOME/.local/bin/zeabur" ]; then
            echo "$ZEABUR_TOKEN" | "$HOME/.local/bin/zeabur" login
          elif [ -x "$HOME/.zeabur/bin/zeabur" ]; then
            echo "$ZEABUR_TOKEN" | "$HOME/.zeabur/bin/zeabur" login
          else
            echo "âŒ æ‰¾ä¸åˆ° zeabur CLIï¼Œè«‹æª¢æŸ¥å‰ä¸€æ­¥æ˜¯å¦å®‰è£æˆåŠŸ" >&2
            exit 127
          fi

      - name: æº–å‚™éƒ¨ç½²æª”æ¡ˆ
        run: |
          echo "ğŸ“ æº–å‚™éƒ¨ç½²æª”æ¡ˆ..."
          mkdir -p deploy

          echo "ğŸ“‚ åˆ—å‡ºå·¥ä½œç›®éŒ„å…§å®¹"
          ls -la
          echo "ğŸ“‚ å¾Œç«¯å»ºç½®ç›®éŒ„ï¼šbackend-build"
          ls -la ./backend-build || true
          echo "ğŸ“‚ å‰ç«¯å»ºç½®ç›®éŒ„ï¼šfrontend-build"
          ls -la ./frontend-build || true
          
          # è¤‡è£½å¾Œç«¯å»ºç½®æˆå“
          if [ -d "./backend-build" ]; then
            cp -r ./backend-build/* deploy/
            echo "âœ… å¾Œç«¯å»ºç½®æˆå“å·²è¤‡è£½"
          fi
          
          # è¤‡è£½å‰ç«¯å»ºç½®æˆå“
          if [ -d "./frontend-build" ]; then
            cp -r ./frontend-build/* deploy/
            echo "âœ… å‰ç«¯å»ºç½®æˆå“å·²è¤‡è£½"
          fi
          
          # è¤‡è£½å¿…è¦çš„é…ç½®æª”æ¡ˆ
          if [ -f "HealthRecord/package.json" ]; then
            cp HealthRecord/package.json deploy/
            echo "âœ… package.json å·²è¤‡è£½"
          fi
          
          if [ -f "HealthRecord-FE/package.json" ]; then
            cp HealthRecord-FE/package.json deploy/
            echo "âœ… å‰ç«¯ package.json å·²è¤‡è£½"
          fi

      - name: éƒ¨ç½²åˆ° Zeabur
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          ZEABUR_PROJECT_ID: ${{ secrets.ZEABUR_PROJECT_ID }}
        run: |
          echo "ğŸš€ é–‹å§‹éƒ¨ç½²åˆ° Zeabur..."
          echo "ğŸ“ ç’°å¢ƒ: ${{ needs.validate-inputs.outputs.environment }}"
          echo "ğŸ—ï¸ å¾Œç«¯åˆ†æ”¯: ${{ needs.validate-inputs.outputs.backend-branch }}"
          echo "ğŸ¨ å‰ç«¯åˆ†æ”¯: ${{ needs.validate-inputs.outputs.frontend-branch }}"
          
          # æ ¹æ“šç’°å¢ƒè¨­å®šä¸åŒçš„éƒ¨ç½²é…ç½®
          case "${{ needs.validate-inputs.outputs.environment }}" in
            "dev")
              zeabur deploy --project $ZEABUR_PROJECT_ID --environment development --source ./deploy
              ;;
            "stg")
              zeabur deploy --project $ZEABUR_PROJECT_ID --environment staging --source ./deploy
              ;;
            "prod")
              zeabur deploy --project $ZEABUR_PROJECT_ID --environment production --source ./deploy
              ;;
          esac

      - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          sleep 30

      - name: æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹
        run: |
          echo "ğŸ” æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹..."
          zeabur status --project $ZEABUR_PROJECT_ID

  notify-deployment:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-to-zeabur]
    if: always()
    steps:
      - name: éƒ¨ç½²çµæœé€šçŸ¥
        run: |
          if [ "${{ needs.deploy-to-zeabur.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ‰ æ‚¨çš„æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° Zeabur ${{ needs.deploy-to-zeabur.outputs.environment }} ç’°å¢ƒ"
          else
            echo "âŒ éƒ¨ç½²å¤±æ•—"
            echo "ğŸ’¡ è«‹æª¢æŸ¥éƒ¨ç½²æ—¥èªŒä»¥äº†è§£è©³ç´°éŒ¯èª¤è³‡è¨Š"
          fi

      - name: å»ºç«‹éƒ¨ç½²æ‘˜è¦
        run: |
          echo "## ğŸš€ Zeabur éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç’°å¢ƒ**: ${{ needs.validate-inputs.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¾Œç«¯åˆ†æ”¯**: ${{ needs.validate-inputs.outputs.backend-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯åˆ†æ”¯**: ${{ needs.validate-inputs.outputs.frontend-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ™‚é–“**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²ç‹€æ…‹**: ${{ needs.deploy-to-zeabur.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-to-zeabur.result }}" == "success" ]; then
            echo "- **çµæœ**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **çµæœ**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ å¯ç”¨åˆ†æ”¯è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ—ï¸ å¾Œç«¯å°ˆæ¡ˆ (HealthRecord) å¯ç”¨åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cd HealthRecord && git branch -r | grep -v HEAD | sed 's/origin\///' | sort -u >> $GITHUB_STEP_SUMMARY
          cd .. >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¨ å‰ç«¯å°ˆæ¡ˆ (HealthRecord-FE) å¯ç”¨åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cd HealthRecord-FE && git branch -r | grep -v HEAD | sed 's/origin\///' | sort -u >> $GITHUB_STEP_SUMMARY
          cd .. >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
