name: E2E - Docker Compose

on:
  workflow_dispatch:
    inputs:
      compose_build:
        description: "是否 --build 重建映像 (true/false)"
        required: false
        default: "true"
      compose_flags:
        description: "額外 docker compose 參數 (可留空)"
        required: false
        default: ""
  pull_request:
    branches: [ master ]
    paths:
      - 'HealthRecord/**'
      - 'HealthRecord-FE/**'
      - 'docker-compose.e2e.yml'
      - '.github/workflows/ci-e2e.yml'
  push:
    branches: [ master ]
    paths:
      - 'HealthRecord/**'
      - 'HealthRecord-FE/**'
      - 'docker-compose.e2e.yml'

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  e2e:
    name: Run E2E via Docker Compose
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Verify repository contents
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la
          echo "--- HealthRecord ---" && ls -la HealthRecord || true
          echo "--- HealthRecord-FE ---" && ls -la HealthRecord-FE || true
          test -f HealthRecord/Dockerfile && echo "✅ Found HealthRecord/Dockerfile" || (echo "❌ Missing HealthRecord/Dockerfile" && exit 1)
          test -f HealthRecord-FE/Dockerfile && echo "✅ Found HealthRecord-FE/Dockerfile" || echo "⚠️ Missing HealthRecord-FE/Dockerfile (may be expected)"
          test -f HealthRecord-FE/Dockerfile.cypress && echo "✅ Found HealthRecord-FE/Dockerfile.cypress" || (echo "❌ Missing HealthRecord-FE/Dockerfile.cypress" && exit 1)

      - name: Show Docker versions
        run: |
          docker -v
          docker compose version || true

      - name: Run E2E (docker compose)
        working-directory: ${{ github.workspace }}
        run: |
          # Workaround for local 'act' runner: disable BuildKit/bake to avoid
          # "failed to find target default" when composing builds
          if [ "${ACT}" = "true" ]; then
            echo "Detected act runner → disabling BuildKit/bake"
            export DOCKER_BUILDKIT=0
            export COMPOSE_DOCKER_CLI_BUILD=0
            docker -v
            docker compose version || true
            docker buildx version || true
          fi

          BUILD_FLAG="${{ github.event.inputs.compose_build }}"
          EXTRA_FLAGS="${{ github.event.inputs.compose_flags }}"
          if [ "$BUILD_FLAG" = "false" ]; then
            docker compose -f "${GITHUB_WORKSPACE}/docker-compose.e2e.yml" up --abort-on-container-exit --exit-code-from cypress $EXTRA_FLAGS
          else
            docker compose -f "${GITHUB_WORKSPACE}/docker-compose.e2e.yml" up --build --abort-on-container-exit --exit-code-from cypress $EXTRA_FLAGS
          fi

      - name: Upload Cypress Artifacts (HTML + Screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts-${{ github.run_number }}
          path: |
            HealthRecord-FE/cypress/reports/html/
            HealthRecord-FE/cypress/screenshots/
          if-no-files-found: ignore
          retention-days: 30

      - name: Add Summary
        if: always()
        run: |
          echo "## 🧪 Cypress E2E 測試" >> $GITHUB_STEP_SUMMARY
          if [ -f "HealthRecord-FE/cypress/reports/html/index.html" ]; then
            echo "✅ 報告已產生：HealthRecord-FE/cypress/reports/html/index.html" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ 找不到 HTML 報告（可能測試前即失敗）" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Prepare Pages content (copy report)
        if: always()
        run: |
          mkdir -p site
          if [ -d "HealthRecord-FE/cypress/reports/html" ]; then
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              DEST="site/reports/pr-${{ github.event.number }}-run-${{ github.run_number }}"
            else
              DEST="site/reports/run-${{ github.run_number }}"
            fi
            mkdir -p "$DEST"
            cp -r HealthRecord-FE/cypress/reports/html/* "$DEST/"
            echo "Report copied to $DEST"
          else
            echo "No HTML report directory to publish"
          fi

      - name: Configure GitHub Pages
        if: always()
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
          name: e2e-report-${{ github.run_id }}

      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: e2e-report-${{ github.run_id }}

      - name: Append Pages URL to summary
        if: always()
        run: |
          if [ -n "${{ steps.deployment.outputs.page_url }}" ]; then
            echo "🔗 線上報告：${{ steps.deployment.outputs.page_url }}reports/run-${{ github.run_number }}/index.html" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "🔗 PR 報告：${{ steps.deployment.outputs.page_url }}reports/pr-${{ github.event.number }}-run-${{ github.run_number }}/index.html" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Enforce failure if any test failed (parse JSON reports)
        if: always()
        run: |
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          REPORT_ROOT="HealthRecord-FE/cypress/reports"
          if [ -d "$REPORT_ROOT" ]; then
            JSON_FILES=$(find "$REPORT_ROOT" -type f -name "*.json" || true)
            TOTAL_FAILS=0
            for f in $JSON_FILES; do
              FAILS=$(jq -r '.stats.failures // 0' "$f" 2>/dev/null || echo 0)
              TOTAL_FAILS=$((TOTAL_FAILS + FAILS))
            done
            echo "Aggregated failures: $TOTAL_FAILS"
            if [ "$TOTAL_FAILS" -gt 0 ]; then
              echo "❌ 有測試失敗，將此工作標記為失敗" >&2
              exit 1
            else
              echo "✅ 所有測試通過"
            fi
          else
            echo "⚠️ 找不到報告資料夾，若上方步驟顯示測試已執行且成功，視為通過；否則標紅更保守"
            # 若想更保守可改成 exit 1
          fi
